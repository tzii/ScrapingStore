<!DOCTYPE html>
<html lang="en" x-data :class="{ 'dark': $store.theme.isDark }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrapingStore Analytics</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Theme initialization
        const getTheme = () => {
            if (localStorage.getItem('theme')) {
                return localStorage.getItem('theme') === 'dark';
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches;
        };

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#080808',
                            800: '#121212',
                            700: '#18181b',
                        },
                        primary: '#5e6ad2',
                        success: '#27cbc0',
                        danger: '#f43f5e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Grid.js -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Dynamic Theme Variables for Grid.js */
        :root {
            --grid-text: #374151;
            --grid-bg: #ffffff;
            --grid-border: #e5e7eb;
            --grid-head-bg: #f9fafb;
            --grid-hover: #f3f4f6;
            --grid-input-bg: #ffffff;
            --grid-input-border: #d1d5db;
        }

        .dark {
            --grid-text: #e5e7eb;
            --grid-bg: #121212;
            --grid-border: #27272a;
            --grid-head-bg: #18181b;
            --grid-hover: #18181b;
            --grid-input-bg: #18181b;
            --grid-input-border: #27272a;
        }

        /* Grid.js Theme Overrides */
        .gridjs-container {
            color: var(--grid-text) !important;
            background: transparent !important;
            border: none !important;
        }

        .gridjs-wrapper {
            border-radius: 0.5rem;
            border: 1px solid var(--grid-border) !important;
            box-shadow: none !important;
        }

        .gridjs-head {
            background-color: transparent !important;
        }

        th.gridjs-th {
            background-color: var(--grid-head-bg) !important;
            color: var(--grid-text) !important;
            border-bottom: 1px solid var(--grid-border) !important;
            border-top: none !important;
        }

        td.gridjs-td {
            background-color: var(--grid-bg) !important;
            color: var(--grid-text) !important;
            border-bottom: 1px solid var(--grid-border) !important;
        }

        .gridjs-tr:hover td.gridjs-td {
            background-color: var(--grid-hover) !important;
        }

        .gridjs-footer {
            background-color: var(--grid-bg) !important;
            border-top: 1px solid var(--grid-border) !important;
        }

        .gridjs-pagination .gridjs-pages button {
            background-color: var(--grid-head-bg) !important;
            color: var(--grid-text) !important;
            border: 1px solid var(--grid-border) !important;
        }

        .gridjs-pagination .gridjs-pages button:hover {
            background-color: var(--grid-hover) !important;
        }

        .gridjs-pagination .gridjs-pages button.gridjs-currentPage {
            background-color: #5e6ad2 !important;
            border-color: #5e6ad2 !important;
            color: white !important;
        }

        /* Fix Search Input */
        input.gridjs-input {
            background-color: var(--grid-input-bg);
            border: 1px solid var(--grid-input-border);
            color: var(--grid-text);
        }
    </style>
</head>

<body
    class="bg-gray-50 dark:bg-dark-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col p-4 md:p-8 transition-colors duration-200"
    x-data="dashboard()">

    <!-- Splash Screen -->
    <div x-show="showSplash" x-transition:leave="transition ease-in duration-500" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-50 dark:bg-dark-900 text-gray-900 dark:text-gray-100">
        <div
            class="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-primary rounded-2xl flex items-center justify-center shadow-2xl shadow-indigo-500/30 mb-6 animate-bounce">
            <span class="text-4xl font-bold text-white">S</span>
        </div>
        <h1 class="text-2xl font-bold tracking-tight mb-2">ScrapingStore Analytics</h1>
        <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
            <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span>
            Loading Real-time Data...
        </div>
    </div>

    <!-- Header -->
    <header
        class="max-w-7xl mx-auto w-full flex justify-between items-center mb-8 pb-6 border-b border-gray-200 dark:border-gray-800">
        <div class="flex items-center gap-4">
            <div
                class="w-10 h-10 bg-gradient-to-tr from-indigo-500 to-primary rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <span class="text-xl font-bold">S</span>
            </div>
            <div>
                <h1 class="text-xl font-semibold tracking-tight">Analytics Dashboard</h1>
                <p class="text-xs text-gray-500">Real-time Data Pipeline</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button @click="$store.theme.toggle()"
                class="p-2 rounded-lg bg-gray-200 dark:bg-dark-800 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                <!-- Sun Icon -->
                <svg x-show="!$store.theme.isDark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon -->
                <svg x-show="$store.theme.isDark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
            <div
                class="flex items-center gap-3 bg-success/10 border border-success/20 px-3 py-1 rounded-full text-success text-xs font-medium">
                <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span>
                Live Data
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto w-full grid grid-cols-12 gap-6 mb-8">

        <!-- KPI Cards -->
        <div
            class="col-span-12 md:col-span-4 lg:col-span-3 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 flex flex-col justify-between h-36 hover:border-gray-300 dark:hover:border-gray-700 transition-colors shadow-sm dark:shadow-none">
            <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium">
                <span>üì¶</span> Total Products
            </div>
            <div class="text-4xl font-bold tracking-tight" x-text="kpi.total">0</div>
            <div class="text-xs text-gray-500">100% Success Rate</div>
        </div>

        <div
            class="col-span-12 md:col-span-4 lg:col-span-3 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 flex flex-col justify-between h-36 hover:border-gray-300 dark:hover:border-gray-700 transition-colors shadow-sm dark:shadow-none">
            <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium">
                <span>üí∞</span> Avg Price
            </div>
            <div class="text-4xl font-bold tracking-tight" x-text="'‚Ç¨' + kpi.avg">‚Ç¨0.00</div>
            <div class="text-xs text-gray-500">Market Average</div>
        </div>

        <div
            class="col-span-12 md:col-span-4 lg:col-span-3 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 flex flex-col justify-between h-36 hover:border-gray-300 dark:hover:border-gray-700 transition-colors shadow-sm dark:shadow-none">
            <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium">
                <span>üíé</span> Premium Items
            </div>
            <div class="text-4xl font-bold tracking-tight" x-text="kpi.premium">0</div>
            <div class="text-xs text-gray-500">Products > ‚Ç¨85.00</div>
        </div>

        <div
            class="col-span-12 md:col-span-12 lg:col-span-3 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 flex flex-col justify-between h-36 hover:border-gray-300 dark:hover:border-gray-700 transition-colors shadow-sm dark:shadow-none">
            <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium">
                <span>‚ö°</span> Availability
            </div>
            <div class="text-4xl font-bold tracking-tight text-success" x-text="kpi.avail_pct">0%</div>
            <div class="text-xs text-gray-500" x-text="kpi.avail_label">Unknown</div>
        </div>

        <!-- Charts -->
        <div
            class="col-span-12 lg:col-span-8 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 h-96 shadow-sm dark:shadow-none">
            <h3 class="text-lg font-medium mb-4">Price Distribution</h3>
            <div class="h-72 w-full">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div
            class="col-span-12 lg:col-span-4 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 h-96 shadow-sm dark:shadow-none">
            <h3 class="text-lg font-medium mb-4">Price Segments</h3>
            <div class="h-72 w-full flex items-center justify-center">
                <canvas id="segmentChart"></canvas>
            </div>
        </div>

        <!-- Data Table (Grid.js) -->
        <div
            class="col-span-12 lg:col-span-8 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 min-h-[500px] shadow-sm dark:shadow-none">
            <h3 class="text-lg font-medium mb-4">Product Catalog</h3>
            <div id="grid-table"></div>
        </div>

        <!-- Franchise List -->
        <div
            class="col-span-12 lg:col-span-4 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-800 rounded-2xl p-6 min-h-[500px] shadow-sm dark:shadow-none">
            <h3 class="text-lg font-medium mb-4">Top Franchises</h3>
            <div class="space-y-4">
                <template x-for="f in franchises" :key="f.name">
                    <div class="flex items-center group">
                        <div class="flex-1 text-sm text-gray-600 dark:text-gray-300 group-hover:text-black dark:group-hover:text-white transition-colors"
                            x-text="f.name"></div>
                        <div class="flex-1 mx-4 h-1.5 bg-gray-200 dark:bg-dark-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full"
                                :style="`width: ${(f.count / maxFranchise) * 100}%`"></div>
                        </div>
                        <div class="w-8 text-right text-xs font-mono text-gray-500" x-text="f.count"></div>
                    </div>
                </template>
            </div>
        </div>

    </main>

    <footer
        class="max-w-7xl mx-auto w-full text-center text-gray-600 text-sm py-8 border-t border-gray-200 dark:border-gray-800 mt-auto">
        Generated on {{ timestamp }} ‚Ä¢ ScrapingStore Analytics
    </footer>

    <script>
        // --- Data Injection ---
        // Data is now loaded from script tags below to prevent XSS
        /*
        const productsData = {{ products_json | safe }};
        const franchiseData = {{ franchise_json | safe }};
        const kpiData = {
            total: {{ kpi_total }},
            avg: "{{ kpi_avg }}",
            premium: {{ kpi_premium }}
        };
        */

        // --- Alpine Component ---
        document.addEventListener('alpine:init', () => {
            Alpine.store('theme', {
                isDark: getTheme(),
                toggle() {
                    this.isDark = !this.isDark;
                    localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
                    // Dispatch event for components to react
                    window.dispatchEvent(new CustomEvent('theme-changed', { detail: { isDark: this.isDark } }));
                }
            });
        });

        // Parse Safe JSON
        const productsData = JSON.parse(document.getElementById('products-data').textContent);
        const franchiseData = JSON.parse(document.getElementById('franchise-data').textContent);
        const rawKpi = JSON.parse(document.getElementById('kpi-data').textContent);
        const chartData = JSON.parse(document.getElementById('chart-data').textContent);

        // Map KPI to expected format if needed
        const kpiData = {
            total: rawKpi.total,
            avg: rawKpi.avg,
            premium: rawKpi.premium,
            avail_pct: rawKpi.avail_pct,
            avail_label: rawKpi.avail_label
        };

        function dashboard() {
            return {
                showSplash: true,
                kpi: kpiData,
                franchises: franchiseData,
                maxFranchise: Math.max(...franchiseData.map(d => d.count)) || 1,
                init() {
                    // Splash Screen Timer
                    setTimeout(() => {
                        this.showSplash = false;
                    }, 2000);

                    this.initCharts();
                    this.initGrid();
                },
                charts: {},
                updateCharts(e) {
                    const isDark = e.detail.isDark;
                    const gridColor = isDark ? '#27272a' : '#e5e7eb';
                    const textColor = isDark ? '#9ca3af' : '#4b5563';
                    const theadColor = isDark ? '#18181b' : '#f9fafb';

                    // Update Chart.js instances
                    Object.values(this.charts).forEach(chart => {
                        if (chart.options.scales.x) { // If it has axes
                            chart.options.scales.x.ticks.color = textColor;
                            chart.options.scales.y.ticks.color = textColor;
                            chart.options.scales.y.grid.color = gridColor;
                        }
                        if (chart.options.plugins.legend) {
                            chart.options.plugins.legend.labels.color = textColor;
                        }
                        chart.update();
                    });

                    // Force Grid.js re-render if needed via key hack or just accept CSS handling it (CSS vars handle most)
                    // CSS vars --grid-text etc. are already bound to .dark class, so Grid.js updates automatically except for some specific elements
                },
                initCharts() {
                    // Listen for theme changes
                    window.addEventListener('theme-changed', (e) => this.updateCharts(e));

                    const isDark = Alpine.store('theme').isDark;
                    const gridColor = isDark ? '#27272a' : '#e5e7eb';
                    const textColor = isDark ? '#9ca3af' : '#4b5563';

                    // Price Chart Logic
                    const priceCtx = document.getElementById('priceChart').getContext('2d');

                    this.charts.price = new Chart(priceCtx, {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Product Count',
                                data: chartData.counts,
                                backgroundColor: '#5e6ad2',
                                borderRadius: 4,
                                hoverBackgroundColor: '#747fdb'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    grid: { color: gridColor },
                                    ticks: { color: textColor }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: textColor }
                                }
                            }
                        }
                    });

                    // Segment Chart
                    const segmentCtx = document.getElementById('segmentChart').getContext('2d');
                    let budget = 0, mid = 0, premium = 0, luxury = 0;
                    productsData.forEach(p => {
                        if (p.price < 70) budget++;
                        else if (p.price < 80) mid++;
                        else if (p.price < 90) premium++;
                        else luxury++;
                    });

                    this.charts.segment = new Chart(segmentCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Budget', 'Mid', 'Premium', 'Luxury'],
                            datasets: [{
                                data: [budget, mid, premium, luxury],
                                backgroundColor: ['#27cbc0', '#f59e0b', '#5e6ad2', '#f43f5e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: { position: 'right', labels: { color: textColor, usePointStyle: true } }
                            }
                        }
                    });
                },
                initGrid() {
                    const isDark = Alpine.store('theme').isDark;

                    new gridjs.Grid({
                        columns: [
                            { name: 'Product Name', width: '50%' },
                            {
                                name: 'Price',
                                width: '20%',
                                formatter: (cell) => gridjs.html(`<span class="px-2 py-1 rounded ${isDark ? 'bg-white/5' : 'bg-gray-100'} font-mono text-xs">‚Ç¨${parseFloat(cell).toFixed(2)}</span>`)
                            },
                            {
                                name: 'Status',
                                width: '30%',
                                formatter: (cell) => gridjs.html(`<span class="text-success text-xs">‚óè ${cell}</span>`)
                            }
                        ],
                        data: productsData.map(p => [p.name, p.price, p.availability]),
                        search: true,
                        sort: true,
                        pagination: { limit: 10 },
                        className: {
                            table: 'w-full text-sm text-left',
                            thead: `text-xs uppercase ${isDark ? 'text-gray-400 bg-dark-700' : 'text-gray-500 bg-gray-50'}`,
                            tbody: isDark ? 'bg-dark-800' : 'bg-white'
                        }
                    }).render(document.getElementById("grid-table"));
                }
            }
        }
    </script>

    <!-- Safe Data Injection -->
    <script id="products-data" type="application/json">{{ products_json | safe }}</script>
    <script id="franchise-data" type="application/json">{{ franchise_json | safe }}</script>
    <script id="kpi-data" type="application/json">
    {
        "total": {{ kpi_total }},
        "avg": "{{ kpi_avg }}",
        "premium": {{ kpi_premium }},
        "avail_pct": "{{ kpi_availability_pct }}",
        "avail_label": "{{ kpi_availability_label }}"
    }
    </script>
    <script id="chart-data" type="application/json">{{ chart_data_json | safe }}</script>
</body>

</html>